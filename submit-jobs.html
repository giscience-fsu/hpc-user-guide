<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Submitting jobs | HPC User Guide</title>
  <meta name="description" content="Chapter 4 Submitting jobs | HPC User Guide" />
  <meta name="generator" content="bookdown 0.21.6 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Submitting jobs | HPC User Guide" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Submitting jobs | HPC User Guide" />
  
  
  

<meta name="author" content="Patrick Schratz, Jannes Muenchow" />


<meta name="date" content="2021-02-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="scheduler.html"/>
<link rel="next" href="troubleshooting-and-cautionary-notes.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#web-address"><i class="fa fa-check"></i><b>1.1</b> Web Address</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#hardware"><i class="fa fa-check"></i><b>1.2</b> Hardware</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#software"><i class="fa fa-check"></i><b>1.3</b> Software</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#data-storage"><i class="fa fa-check"></i><b>1.4</b> Data storage</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#accessing-files-from-your-local-computer"><i class="fa fa-check"></i><b>1.5</b> Accessing files from your local computer</a><ul>
<li class="chapter" data-level="1.5.1" data-path="index.html"><a href="index.html#unix"><i class="fa fa-check"></i><b>1.5.1</b> Unix</a></li>
<li class="chapter" data-level="1.5.2" data-path="index.html"><a href="index.html#windows"><i class="fa fa-check"></i><b>1.5.2</b> Windows</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#accessing-the-hpc-remotely-vpn"><i class="fa fa-check"></i><b>1.6</b> Accessing the HPC remotely (VPN)</a></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="index.html#sharing-of-results"><i class="fa fa-check"></i><b>1.7</b> Sharing of Results</a><ul>
<li class="chapter" data-level="1.7.1" data-path="index.html"><a href="index.html#workflowr"><i class="fa fa-check"></i><b>1.7.1</b> <code>workflowr</code></a></li>
<li class="chapter" data-level="1.7.2" data-path="index.html"><a href="index.html#local-web-server"><i class="fa fa-check"></i><b>1.7.2</b> Local web server</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="libraries.html"><a href="libraries.html"><i class="fa fa-check"></i><b>2</b> Libraries and Environment Modules</a><ul>
<li class="chapter" data-level="2.1" data-path="libraries.html"><a href="libraries.html#introduction"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="libraries.html"><a href="libraries.html#loading-modules"><i class="fa fa-check"></i><b>2.2</b> Loading modules</a></li>
<li class="chapter" data-level="2.3" data-path="libraries.html"><a href="libraries.html#checking-loaded-modules"><i class="fa fa-check"></i><b>2.3</b> Checking loaded modules</a></li>
<li class="chapter" data-level="2.4" data-path="libraries.html"><a href="libraries.html#default-modules"><i class="fa fa-check"></i><b>2.4</b> Default modules</a></li>
<li class="chapter" data-level="2.5" data-path="libraries.html"><a href="libraries.html#r"><i class="fa fa-check"></i><b>2.5</b> R</a></li>
<li class="chapter" data-level="2.6" data-path="libraries.html"><a href="libraries.html#rstudio-server"><i class="fa fa-check"></i><b>2.6</b> RStudio Server</a></li>
<li class="chapter" data-level="2.7" data-path="libraries.html"><a href="libraries.html#shiny-server"><i class="fa fa-check"></i><b>2.7</b> Shiny Server</a></li>
<li class="chapter" data-level="2.8" data-path="libraries.html"><a href="libraries.html#libraries-1"><i class="fa fa-check"></i><b>2.8</b> Libraries</a><ul>
<li class="chapter" data-level="2.8.1" data-path="libraries.html"><a href="libraries.html#docker"><i class="fa fa-check"></i><b>2.8.1</b> Docker</a></li>
<li class="chapter" data-level="2.8.2" data-path="libraries.html"><a href="libraries.html#osrm"><i class="fa fa-check"></i><b>2.8.2</b> OSRM</a></li>
<li class="chapter" data-level="2.8.3" data-path="libraries.html"><a href="libraries.html#gdal"><i class="fa fa-check"></i><b>2.8.3</b> GDAL</a></li>
</ul></li>
<li class="chapter" data-level="2.9" data-path="libraries.html"><a href="libraries.html#getting-started"><i class="fa fa-check"></i><b>2.9</b> Getting Started</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="scheduler.html"><a href="scheduler.html"><i class="fa fa-check"></i><b>3</b> Scheduler</a><ul>
<li class="chapter" data-level="3.1" data-path="scheduler.html"><a href="scheduler.html#first-steps"><i class="fa fa-check"></i><b>3.1</b> First steps</a></li>
<li class="chapter" data-level="3.2" data-path="scheduler.html"><a href="scheduler.html#slurm-commands"><i class="fa fa-check"></i><b>3.2</b> SLURM commands</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="submit-jobs.html"><a href="submit-jobs.html"><i class="fa fa-check"></i><b>4</b> Submitting jobs</a><ul>
<li class="chapter" data-level="4.1" data-path="submit-jobs.html"><a href="submit-jobs.html#clustermq-setup"><i class="fa fa-check"></i><b>4.1</b> <code>clustermq</code> setup</a></li>
<li class="chapter" data-level="4.2" data-path="submit-jobs.html"><a href="submit-jobs.html#the-scheduler-template"><i class="fa fa-check"></i><b>4.2</b> The scheduler template</a></li>
<li class="chapter" data-level="4.3" data-path="submit-jobs.html"><a href="submit-jobs.html#allocating-resources"><i class="fa fa-check"></i><b>4.3</b> Allocating resources</a></li>
<li class="chapter" data-level="4.4" data-path="submit-jobs.html"><a href="submit-jobs.html#monitoring-progress"><i class="fa fa-check"></i><b>4.4</b> Monitoring progress</a></li>
<li class="chapter" data-level="4.5" data-path="submit-jobs.html"><a href="submit-jobs.html#summary"><i class="fa fa-check"></i><b>4.5</b> Summary</a></li>
<li class="chapter" data-level="4.6" data-path="submit-jobs.html"><a href="submit-jobs.html#best-practice"><i class="fa fa-check"></i><b>4.6</b> Best practice</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="troubleshooting-and-cautionary-notes.html"><a href="troubleshooting-and-cautionary-notes.html"><i class="fa fa-check"></i><b>5</b> Troubleshooting and Cautionary Notes</a><ul>
<li class="chapter" data-level="5.1" data-path="troubleshooting-and-cautionary-notes.html"><a href="troubleshooting-and-cautionary-notes.html#cautionary-notes"><i class="fa fa-check"></i><b>5.1</b> Cautionary Notes</a></li>
<li class="chapter" data-level="5.2" data-path="troubleshooting-and-cautionary-notes.html"><a href="troubleshooting-and-cautionary-notes.html#faq"><i class="fa fa-check"></i><b>5.2</b> FAQ</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">HPC User Guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="submit-jobs" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Submitting jobs</h1>
<div id="clustermq-setup" class="section level2">
<h2><span class="header-section-number">4.1</span> <code>clustermq</code> setup</h2>
<p>Every job submission is done via <code>clustermq::Q()</code> (either directly or via <code>drake</code>).
See the setup instructions in the <a href="https://mschubert.github.io/clustermq/">clustermq</a> package on how to setup the package.</p>
<p>First, you need to set some options in your <code>.Rprofile</code> (on the master node or in your project root when you use <em>packrat</em>):</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="submit-jobs.html#cb20-1"></a><span class="kw">options</span>(</span>
<span id="cb20-2"><a href="submit-jobs.html#cb20-2"></a>    <span class="dt">clustermq.scheduler =</span> <span class="st">&quot;slurm&quot;</span>,</span>
<span id="cb20-3"><a href="submit-jobs.html#cb20-3"></a>    <span class="dt">clustermq.template =</span> <span class="st">&quot;&lt;/path/to/file/&quot;</span></span>
<span id="cb20-4"><a href="submit-jobs.html#cb20-4"></a>)</span></code></pre></div>
<p>See the <a href="https://mschubert.github.io/clustermq/articles/userguide.html#slurm">package vignette</a> on how to set up the file.</p>
<p>Note that you can have multiple <code>.Rprofile</code> files on your system:</p>
<ol style="list-style-type: decimal">
<li>Your default R interpreter will use the <code>.Rprofile</code> found in the home directory (<code>~/</code>).</li>
<li>But you can also save an <code>.Rprofile</code> file in the root directory of a (RStudio) project (which will be preferred over the one in $HOME).</li>
</ol>
<p>This way you can use customized <code>.Rprofile</code> files tailored to a project.</p>
<p>At this stage you should be able to run the <a href="https://github.com/mschubert/clustermq">example</a> at the top of the <code>README</code> of the <em>clustermq</em> package.
It is a very simple example which finishes in a few seconds.
If it does not work, you either did something wrong or the nodes are busy.
Check with <code>sinfo</code> and <code>squeue</code>.
Otherwise see the <a href="#troubleshooting">troubleshooting</a> chapter.</p>
<div class="rmdcaution">
<p>
Be aware of setting <code>n_cpus</code> in the <code>template</code> argument of <code>clustermq::Q()</code> if your submitted job is parallelized! If you submit a job that is parallelized without telling the scheduler, the scheduler will reserve 1 core for this job (because it thinks it is sequential) but in fact multiple processes will spawn. This will potentially affect all running processes on the server since the scheduler will accept more processing than it actually can take.
</p>
</div>
</div>
<div id="the-scheduler-template" class="section level2">
<h2><span class="header-section-number">4.2</span> The scheduler template</h2>
<p>To successfully submit jobs to the scheduler, you need to set the <code>.Rprofile</code> options given above.
Note that you can add any bash commands into the scripts between the <code>SBATCH</code> section and the final R call.
For example, one of my templates looks like this:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb21-1"><a href="submit-jobs.html#cb21-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb21-2"><a href="submit-jobs.html#cb21-2"></a><span class="co">#SBATCH --job-name={{ job_name }}</span></span>
<span id="cb21-3"><a href="submit-jobs.html#cb21-3"></a><span class="co">#SBATCH --partition=all</span></span>
<span id="cb21-4"><a href="submit-jobs.html#cb21-4"></a><span class="co">#SBATCH --output={{ log_file | /dev/null }} # you can add .%a for array index</span></span>
<span id="cb21-5"><a href="submit-jobs.html#cb21-5"></a><span class="co">#SBATCH --error={{ log_file | /dev/null }}</span></span>
<span id="cb21-6"><a href="submit-jobs.html#cb21-6"></a><span class="co">#SBATCH --cpus-per-task={{ n_cpus }}</span></span>
<span id="cb21-7"><a href="submit-jobs.html#cb21-7"></a><span class="co">#SBATCH --mem={{ memory }}</span></span>
<span id="cb21-8"><a href="submit-jobs.html#cb21-8"></a><span class="co">#SBATCH --array=1-{{ n_jobs }}</span></span>
<span id="cb21-9"><a href="submit-jobs.html#cb21-9"></a></span>
<span id="cb21-10"><a href="submit-jobs.html#cb21-10"></a><span class="bu">cd</span> path/to/project</span>
<span id="cb21-11"><a href="submit-jobs.html#cb21-11"></a></span>
<span id="cb21-12"><a href="submit-jobs.html#cb21-12"></a><span class="co"># load desired R version</span></span>
<span id="cb21-13"><a href="submit-jobs.html#cb21-13"></a><span class="ex">module</span> load r-3.5.2-gcc-9.2.0-4syrmqv</span>
<span id="cb21-14"><a href="submit-jobs.html#cb21-14"></a></span>
<span id="cb21-15"><a href="submit-jobs.html#cb21-15"></a><span class="va">CMQ_AUTH=</span>{<span class="kw">{</span> <span class="ex">auth</span> <span class="kw">}</span>} <span class="ex">R</span> --no-save --no-restore -e <span class="st">&#39;clustermq:::worker(&quot;{{ master }}&quot;)&#39;</span></span></code></pre></div>
<p>Note: The <code>#</code> signs are no mistakes here, they are no “comment” signs in this context.
The <code>SBATCH</code> commands will be executed here.</p>
<p>You can simply copy it and adjust it to your needs (set the right path to your project and specify the R version you want to use).</p>
</div>
<div id="allocating-resources" class="section level2">
<h2><span class="header-section-number">4.3</span> Allocating resources</h2>
<p>There are two approaches/packages you can use:</p>
<ul>
<li><p><code>drake</code> (recommended)</p></li>
<li><p><code>clustermq</code></p></li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="submit-jobs.html#cb22-1"></a>drake<span class="op">::</span><span class="kw">make</span>(<span class="dt">parallelism =</span> <span class="st">&quot;clustermq&quot;</span>, <span class="dt">n_jobs =</span> <span class="dv">1</span>, </span>
<span id="cb22-2"><a href="submit-jobs.html#cb22-2"></a>  <span class="dt">template =</span> <span class="kw">list</span>(<span class="dt">n_cpus =</span> <span class="op">&lt;</span>X<span class="op">&gt;</span>, <span class="dt">log_file =</span> <span class="op">&lt;</span>Y<span class="op">&gt;</span>, <span class="dt">memory =</span> <span class="op">&lt;</span>Z<span class="op">&gt;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="submit-jobs.html#cb23-1"></a>clustermq<span class="op">::</span><span class="kw">Q</span>(<span class="dt">template =</span> <span class="kw">list</span>(<span class="dt">n_cpus =</span> <span class="op">&lt;</span>X<span class="op">&gt;</span>, <span class="dt">log_file =</span> <span class="op">&lt;</span>Y<span class="op">&gt;</span>, <span class="dt">memory =</span> <span class="op">&lt;</span>Z<span class="op">&gt;</span>))</span></code></pre></div>
<p>(The individual components of these calls are explained in more detail below.)</p>
<p>Note that <code>drake</code> uses <code>clustermq</code> under the hood.
Notations like <code>&lt;X&gt;</code> are meant to be read as placeholders, meaning you need to replace them with valid content.)</p>
<p>When submitting jobs via <code>clustermq::Q()</code>, it is important to tell the scheduler how many cores and memory should be reserved for you.
This step is very important.
If you specify less cores than you actually use in your script (e.g. by internal parallelization), the scheduler will plan with X cores although your submitted code will spawn Y processes in the background.
This might overload the node and eventually cause your script (and more importantly) the processes of others to crash.</p>
<p>There are two ways to specify these settings, depending on which approach you use:</p>
<ol style="list-style-type: decimal">
<li>via <code>clustermq::Q()</code> directly</li>
</ol>
<p>Pass the values via argument <code>template</code> like <code>template = list(n_cpus = &lt;X&gt;, memory = &lt;Y&gt;)</code>.
It will then be passed to the <code>clustermq.template</code> file (frequently named <code>slurm_clustermq.tmpl</code>) which contains following lines:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb24-1"><a href="submit-jobs.html#cb24-1"></a><span class="co">#SBATCH --cpus-per-task{{ n_cpus }}</span></span>
<span id="cb24-2"><a href="submit-jobs.html#cb24-2"></a><span class="co">#SBATCH --mem={{ memory }}</span></span></code></pre></div>
<p>This tells the scheduler how many resources (here cpus) your job needs.</p>
<ol start="2" style="list-style-type: decimal">
<li>via <code>drake::make()</code> (recommended)</li>
</ol>
<p>Again, set the options via argument <code>template = list(n_cpus = X, memory = Y)</code>.
See section <a href="https://ropenscilabs.github.io/drake-manual/hpc.html#advanced-options">“The resources column for transient workers”</a> in the drake manual.</p>
<div class="rmdcaution">
<p>
Please think upfront how many cpus and memory your task requires. The following two examples show you the implications of wrong specifications.
</p>
</div>
<div class="rmdcaution">
<p>
<code>mclapply(cores = 20)</code> (in your script) &gt; <code>n_cpus = 16</code>
</p>
<p>
In this case, four workers will always be in “waiting mode” since only 16 cpus can be used by your resource request. This slows down your parallelization but does no harm to other users.
</p>
</div>
<div class="rmdcaution">
<p>
<code>mclapply(cores = 11)</code> &lt; <code>n_cpus = 16</code>
</p>
<p>
In this case, you reserve 16 CPUs from the machine but only use 11 at most. This blocks five CPUs of the machine for no reason potentially causing other people to be added to the queue rather than getting their job processed immediately.
</p>
</div>
<p>Furthermore, if you want to use all resources of a node and run into memory problems, try reducing the number of CPUs (if you already increased the memory to its maximum).
If you scale down the number of CPUs, you will have more memory/cpu available.</p>
</div>
<div id="monitoring-progress" class="section level2">
<h2><span class="header-section-number">4.4</span> Monitoring progress</h2>
<p>When submitting jobs you can track its progress by specifying a <code>log_file</code> in the <code>clustermq::Q()</code> call, e.g. <code>clustermq::Q(template = list(log_file = path/to/file))</code>.</p>
<p>For <code>drake</code>, the equivalent is to specify <code>console_log_file()</code> in either <code>make()</code> or <code>drake_config()</code>.</p>
<p>If your jobs are running on a node, you can SSH into the node, e.g. <code>ssh c0</code>.
There you can take a look at the current load by using <code>htop</code>.
Note that you can only log in if you have a running progress on a specific node.</p>
<p>Another option is to take a look <a href="http://141.35.158.107/ganglia/?r=hour&amp;cs=&amp;ce=&amp;m=load_one&amp;s=by+name&amp;c=OpenHPC&amp;tab=m&amp;vn=&amp;hide-hf=false">Ganglia</a> to see the load of the HPC.</p>
</div>
<div id="summary" class="section level2">
<h2><span class="header-section-number">4.5</span> Summary</h2>
<ol style="list-style-type: decimal">
<li><p>Set up your <code>.Rprofile</code> with <code>options(clustermq.template = "/path/to/file")</code>.
The <code>clustermq.template</code> should point to a SLURM template file in your $HOME or project directory.</p></li>
<li><p>Decide which approach you want to use:</p></li>
</ol>
<ul>
<li><code>drake::make(parallelism = "clustermq", n_jobs = 1, template = list(n_cpus = X, log_file = Y, memory = Z))</code> (recommended!)</li>
<li><code>clustermq::Q(template = list(n_cpus = X, log_file = Y, memory = Z))</code></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>You need to have a Slurm template file in your project directory. This template needs to be linked in your <code>.Rprofile</code> with <code>options(clustermq.template = "/path/to/file")</code>.</li>
</ol>
</div>
<div id="best-practice" class="section level2">
<h2><span class="header-section-number">4.6</span> Best practice</h2>
<p>You can submit as many tasks as you want in separate R sessions, they will be processed as ranked in the queue of the scheduler.
However, submitting single jobs that finish quickly is tedious.
The same applies to the submission of multiple jobs in separate R sessions.</p>
<p>These two points are the reason why it is <em>highly</em> recommended to use <code>drake</code>.
By using <code>drake</code>, all of your intermediate R objects are “targets”.
You can specify any number of targets that should be build when calling <code>drake::make()</code>.
<code>drake</code> will take care that for each target as separate job is created which is then added to the SLURM queue.</p>
<p>For example, if you want to build three R objects named <code>object1</code>, <code>object2</code> and <code>object3</code> in parallel, one on each node:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="submit-jobs.html#cb25-1"></a>drake<span class="op">::</span><span class="kw">make</span>(plan, <span class="dt">targets =</span> <span class="kw">c</span>(<span class="st">&quot;object1&quot;</span>, <span class="st">&quot;object2&quot;</span>, <span class="st">&quot;object3&quot;</span>), <span class="dt">jobs =</span> <span class="dv">3</span>, </span>
<span id="cb25-2"><a href="submit-jobs.html#cb25-2"></a>            <span class="dt">template =</span> <span class="kw">list</span>(<span class="dt">n_cpus =</span> <span class="dv">16</span>, <span class="dt">memory =</span> <span class="st">&quot;100G&quot;</span>, </span>
<span id="cb25-3"><a href="submit-jobs.html#cb25-3"></a>            <span class="dt">log_file =</span> <span class="st">&quot;/path/to/log.txt&quot;</span>))</span></code></pre></div>
<ul>
<li>Creates three jobs which are added to the SLURM queue</li>
<li>Each jobs requires 16 cores</li>
<li>Each job needs 32 GB of memory</li>
<li>The call is finished once all jobs have finished.</li>
</ul>
<p>After they are done, they will be marked as “built” and added to a cache directory by <code>drake</code>, so you cannot accidentally rebuild them (unless you change something substantial in the code).</p>
<p>If you follow this practice, the only thing you need to execute on the cluster will be this call (after you initialized the config by sourcing your <code>drake.R</code> file).</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="scheduler.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="troubleshooting-and-cautionary-notes.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://venus.geogr.uni-jena.de/giscience/hpc-user-guide/edit/master/04-executing-jobs.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["hpc-user-guide-fus-jena.pdf", "hpc-user-guide-fus-jena.epub"]
});
});
</script>

</body>

</html>
